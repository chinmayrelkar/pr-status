#!/bin/bash
# PR Status Checker - Check GitHub PR status
# Usage: 
#   pr-status                          (show all PRs in current repo)
#   pr-status <pr_number>              (must be in a git repo)
#   pr-status <owner/repo>             (show all PRs in repo)
#   pr-status <owner/repo> <pr_number> (show specific PR in repo)

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_status() {
  local status=$1
  case $status in
    SUCCESS)
      echo -ne "${GREEN}✅ SUCCESS${NC}"
      ;;
    FAILURE)
      echo -ne "${RED}❌ FAILURE${NC}"
      ;;
    PENDING)
      echo -ne "${YELLOW}⏳ PENDING${NC}"
      ;;
    *)
      echo -ne "${BLUE}❓ $status${NC}"
      ;;
  esac
}

check_single_pr() {
  local pr_number=$1
  local repo=$2
  local temp_file=$3
  
  # Build command - if repo is provided, use it; otherwise rely on current repo
  local pr_cmd="gh pr view $pr_number"
  if [ -n "$repo" ]; then
    pr_cmd="$pr_cmd --repo $repo"
  fi
  
  # Get PR details
  local title
  local url
  local base_branch
  local head_branch
  
  title=$($pr_cmd --json title -q '.title' 2>/dev/null) || {
    {
      if [ -n "$repo" ]; then
        echo -e "${RED}Error: PR #$pr_number not found in $repo${NC}"
      else
        echo -e "${RED}Error: Could not fetch PR #$pr_number${NC}"
      fi
    } >> "$temp_file"
    return 1
  }
  
  url=$($pr_cmd --json url -q '.url' 2>/dev/null)
  base_branch=$($pr_cmd --json baseRefName -q '.baseRefName' 2>/dev/null)
  head_branch=$($pr_cmd --json headRefName -q '.headRefName' 2>/dev/null)
  
  # Build output
  local output=""
  output+=$(printf "${BLUE}PR #$pr_number:${NC} $title\n")
  if [ -n "$url" ]; then
    output+=$(printf "${BLUE}Link:${NC} $url\n")
  fi
  
  if [ -n "$base_branch" ] && [ -n "$head_branch" ]; then
    output+=$(printf "${CYAN}Branches:${NC} $head_branch → $base_branch\n")
  fi
  output+=$(printf "\n")
  
  # Build status check command
  local status_cmd="gh pr view $pr_number"
  if [ -n "$repo" ]; then
    status_cmd="$status_cmd --repo $repo"
  fi
  
  # Get status checks
  while IFS='|' read -r context state; do
    output+=$(print_status "$state")
    output+=$(printf " - $context\n")
  done < <($status_cmd --json statusCheckRollup -q '.statusCheckRollup[] | "\(.context)|\(.state)"' 2>/dev/null)
  
  # Summary
  output+=$(printf "\n")
  if ! $status_cmd --json statusCheckRollup -q '.statusCheckRollup[] | select(.state=="PENDING" or .state=="FAILURE")' 2>/dev/null | grep -q .; then
    output+=$(printf "${GREEN}✅ All checks passed!${NC}\n")
  elif $status_cmd --json statusCheckRollup -q '.statusCheckRollup[] | select(.state=="PENDING")' 2>/dev/null | grep -q .; then
    output+=$(printf "${YELLOW}⏳ Some checks are still pending${NC}\n")
  elif $status_cmd --json statusCheckRollup -q '.statusCheckRollup[] | select(.state=="FAILURE")' 2>/dev/null | grep -q .; then
    output+=$(printf "${RED}❌ Some checks failed${NC}\n")
  fi
  
  # Display reviews
  local reviews
  reviews=$($status_cmd --json reviews -q '.reviews[] | "\(.author.login)|\(.state)"' 2>/dev/null)
  
  if [ -n "$reviews" ]; then
    output+=$(printf "\n${BLUE}Reviews:${NC}\n")
    while IFS='|' read -r author state; do
      output+=$(printf "  - $author: $state\n")
    done <<< "$reviews"
  fi
  
  output+=$(printf "\n")
  
  # Write to temp file
  echo -e "$output" >> "$temp_file"
}

check_all_prs_in_repo() {
  local repo=$1
  
  if [ -n "$repo" ]; then
    echo -e "${BLUE}Fetching all open PRs in $repo...${NC}\n"
  else
    echo -e "${BLUE}Fetching all open PRs for current user in this repo...${NC}\n"
  fi
  
  local prs
  local pr_cmd="gh pr list --author @me --state open -q '.[].number'"
  
  if [ -n "$repo" ]; then
    pr_cmd="$pr_cmd --repo $repo"
  fi
  
  prs=$($pr_cmd 2>/dev/null) || {
    echo -e "${RED}Error: Could not fetch PRs${NC}"
    return 1
  }
  
  if [ -z "$prs" ]; then
    echo -e "${YELLOW}No open PRs found${NC}"
    return 0
  fi
  
  # Create temp file for collecting output
  local temp_file
  temp_file=$(mktemp)
  
  # Process PRs in parallel
  while read -r pr_number; do
    check_single_pr "$pr_number" "$repo" "$temp_file" &
  done <<< "$prs"
  
  # Wait for all background jobs
  wait
  
  # Print collected output
  cat "$temp_file"
  rm "$temp_file"
}

# Check if we're in a git repository
is_in_git_repo() {
  git rev-parse --git-dir > /dev/null 2>&1
  return $?
}

# Check if argument is a repo (contains /)
is_repo_format() {
  [[ "$1" == *"/"* ]]
}

# Get current repo from git
get_current_repo() {
  local remote_url
  remote_url=$(git config --get remote.origin.url 2>/dev/null)
  if [ -z "$remote_url" ]; then
    return 1
  fi
  # Extract owner/repo from URL
  echo "$remote_url" | sed -E 's|.*[:/]([^/]+)/([^/]+)(.git)?$|\1/\2|'
}

# Main logic
case $# in
  0)
    # Scenario 0: no args
    if is_in_git_repo; then
      local current_repo
      current_repo=$(get_current_repo)
      check_all_prs_in_repo "$current_repo"
    else
      echo -e "${RED}Error: Not in a git repository${NC}"
      echo -e "${YELLOW}Usage:${NC}"
      echo -e "  ${BLUE}pr-status${NC}                              (all PRs in current repo)"
      echo -e "  ${BLUE}pr-status <owner/repo>${NC}                 (all PRs in repo)"
      echo -e "  ${BLUE}pr-status <pr_number>${NC}                  (must be in a git repo)"
      echo -e "  ${BLUE}pr-status <owner/repo> <pr_number>${NC}     (specific PR in repo)\n"
      exit 1
    fi
    ;;
  1)
    # Could be: repo OR pr_number
    if is_repo_format "$1"; then
      # Scenario 2: REPO specified, no PR
      check_all_prs_in_repo "$1"
    else
      # Could be PR number
      if is_in_git_repo; then
        # Scenario 3: CD exists, no REPO, PR specified
        echo -e "${BLUE}Fetching PR #$1 status...${NC}\n"
        check_single_pr "$1" "" "/dev/stdout"
      else
        # Scenario 1: no CD, no REPO, but PR - raise error
        echo -e "${RED}Error: Cannot find PR #$1 without repository context${NC}"
        echo -e "${YELLOW}Usage:${NC}"
        echo -e "  ${BLUE}pr-status${NC}                              (all PRs in current repo)"
        echo -e "  ${BLUE}pr-status <owner/repo>${NC}                 (all PRs in repo)"
        echo -e "  ${BLUE}pr-status <pr_number>${NC}                  (must be in a git repo)"
        echo -e "  ${BLUE}pr-status <owner/repo> <pr_number>${NC}     (specific PR in repo)\n"
        exit 1
      fi
    fi
    ;;
  2)
    # Scenario 4: REPO and PR specified
    echo -e "${BLUE}Fetching PR #$2 status...${NC}\n"
    check_single_pr "$2" "$1" "/dev/stdout"
    ;;
  *)
    echo -e "${RED}Error: Invalid arguments${NC}"
    echo -e "${YELLOW}Usage:${NC}"
    echo -e "  ${BLUE}pr-status${NC}                              (all PRs in current repo)"
    echo -e "  ${BLUE}pr-status <owner/repo>${NC}                 (all PRs in repo)"
    echo -e "  ${BLUE}pr-status <pr_number>${NC}                  (must be in a git repo)"
    echo -e "  ${BLUE}pr-status <owner/repo> <pr_number>${NC}     (specific PR in repo)\n"
    exit 1
    ;;
esac
