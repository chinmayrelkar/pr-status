#!/bin/bash
# PR Status Checker - Check GitHub PR status
# Usage:
#   pr-status                          (show all PRs in current repo)
#   pr-status <pr_number>              (must be in a git repo)
#   pr-status <owner/repo>             (show all PRs in repo)
#   pr-status <owner/repo> <pr_number> (show specific PR in repo)

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
WHITE='\033[0;37m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

print_status() {
  local status=$1
  case $status in
    SUCCESS)
      printf "%bâœ… SUCCESS%b" "${GREEN}" "${NC}"
      ;;
    FAILURE)
      printf "%bâŒ FAILURE%b" "${RED}" "${NC}"
      ;;
    PENDING)
      printf "%bâ³ PENDING%b" "${YELLOW}" "${NC}"
      ;;
    *)
      printf "%bâ“ %s%b" "${BLUE}" "$status" "${NC}"
      ;;
  esac
}

print_separator() {
  local width=80
  printf "%b" "${DIM}"
  printf "â”€%.0s" $(seq 1 $width)
  printf "%b\n" "${NC}"
}

print_header_line() {
  local text="$1"
  local width=80
  printf "%bâ”Œ" "${DIM}"
  printf "â”€%.0s" $(seq 1 $((width - 2)))
  printf "â”%b\n" "${NC}"
  printf "%bâ”‚ %b%-$((width - 4))s %bâ”‚%b\n" "${DIM}" "${BOLD}${CYAN}" "$text" "${DIM}" "${NC}"
  printf "%bâ””" "${DIM}"
  printf "â”€%.0s" $(seq 1 $((width - 2)))
  printf "â”˜%b\n" "${NC}"
}

check_single_pr() {
  local pr_number=$1
  local repo=$2
  local temp_dir=$3

  # Build command - if repo is provided, use it; otherwise rely on current repo
  local pr_cmd="gh pr view $pr_number"
  if [ -n "$repo" ]; then
    pr_cmd="$pr_cmd --repo $repo"
  fi

  # Get PR details
  local title
  local url
  local base_branch
  local head_branch

  title=$($pr_cmd --json title --jq '.title' 2>/dev/null) || {
    {
      if [ -n "$repo" ]; then
        printf "%bâœ— Error:%b PR #$pr_number not found in $repo\n" "${RED}" "${NC}"
      else
        printf "%bâœ— Error:%b Could not fetch PR #$pr_number\n" "${RED}" "${NC}"
      fi
    } > "$temp_dir/pr_$pr_number"
    return 1
  }

  url=$($pr_cmd --json url --jq '.url' 2>/dev/null)
  base_branch=$($pr_cmd --json baseRefName --jq '.baseRefName' 2>/dev/null)
  head_branch=$($pr_cmd --json headRefName --jq '.headRefName' 2>/dev/null)

  # Build output in temp file for this PR
  {
    # Header
    printf "\n"
    printf "%bâ”Œâ”€ %bPR #%s%b %s\n" "${DIM}" "${MAGENTA}${BOLD}" "$pr_number" "${NC}" "$title"
    
    # Link
    if [ -n "$url" ]; then
      printf "%bâ”‚  %bðŸ”— Link:%b\n" "${DIM}" "${BLUE}" "${NC}"
      printf "%bâ”‚     %s\n" "${DIM}" "$url"
    fi

    # Branches
    if [ -n "$base_branch" ] && [ -n "$head_branch" ]; then
      printf "%bâ”‚  %bâŽ‡ Branches:%b\n" "${DIM}" "${CYAN}" "${NC}"
      printf "%bâ”‚     %b%s%b â†’ %b%s%b\n" "${DIM}" "${YELLOW}" "$head_branch" "${NC}" "${YELLOW}" "$base_branch" "${NC}"
    fi

    # Status checks
    printf "%bâ”‚  %bâ—† Checks:%b\n" "${DIM}" "${BLUE}" "${NC}"
    
    # Build status check command
    local status_cmd="gh pr view $pr_number"
    if [ -n "$repo" ]; then
      status_cmd="$status_cmd --repo $repo"
    fi

    # Get status checks
    local has_checks=false
    local check_output
    check_output=$($status_cmd --json statusCheckRollup --jq '.statusCheckRollup[] | "\(.context)|\(.state)"' 2>/dev/null)
    
    if [ -n "$check_output" ]; then
      has_checks=true
      while IFS='|' read -r context state; do
        printf "%bâ”‚     " "${DIM}"
        print_status "$state"
        printf " %s\n" "$context"
      done <<< "$check_output"
    fi

    # Summary
    printf "%bâ”‚  %bâ™¦ Status:%b " "${DIM}" "${BLUE}" "${NC}"
    if ! $status_cmd --json statusCheckRollup --jq '.statusCheckRollup[] | select(.state=="PENDING" or .state=="FAILURE")' 2>/dev/null | grep -q .; then
      printf "%bâœ“ All checks passed!%b\n" "${GREEN}${BOLD}" "${NC}"
    elif $status_cmd --json statusCheckRollup --jq '.statusCheckRollup[] | select(.state=="PENDING")' 2>/dev/null | grep -q .; then
      printf "%bâ³ Some checks are still pending%b\n" "${YELLOW}${BOLD}" "${NC}"
    elif $status_cmd --json statusCheckRollup --jq '.statusCheckRollup[] | select(.state=="FAILURE")' 2>/dev/null | grep -q .; then
      printf "%bâœ— Some checks failed%b\n" "${RED}${BOLD}" "${NC}"
    else
      printf "%b? No checks found%b\n" "${DIM}" "${NC}"
    fi

    # Display reviews
    local reviews
    reviews=$($status_cmd --json reviews --jq '.reviews[] | "\(.author.login)|\(.state)"' 2>/dev/null)

    if [ -n "$reviews" ]; then
      printf "%bâ”‚  %bðŸ‘¥ Reviews:%b\n" "${DIM}" "${BLUE}" "${NC}"
      while IFS='|' read -r author state; do
        local review_icon
        case $state in
          APPROVED)
            review_icon="âœ“"
            printf "%bâ”‚     %b%s%b %s (%s)\n" "${DIM}" "${GREEN}" "$review_icon" "${NC}" "$author" "$state"
            ;;
          COMMENTED)
            review_icon="ðŸ’¬"
            printf "%bâ”‚     %b%s%b %s (%s)\n" "${DIM}" "${BLUE}" "$review_icon" "${NC}" "$author" "$state"
            ;;
          CHANGES_REQUESTED)
            review_icon="âœ—"
            printf "%bâ”‚     %b%s%b %s (%s)\n" "${DIM}" "${RED}" "$review_icon" "${NC}" "$author" "$state"
            ;;
          DISMISSED)
            review_icon="â—‹"
            printf "%bâ”‚     %b%s%b %s (%s)\n" "${DIM}" "${DIM}" "$review_icon" "${NC}" "$author" "$state"
            ;;
          *)
            printf "%bâ”‚     ? %s (%s)\n" "${DIM}" "$author" "$state"
            ;;
        esac
      done <<< "$reviews"
    fi

    printf "%bâ””â”€ %s\n" "${DIM}" "$(date +'%Y-%m-%d %H:%M:%S' 2>/dev/null || echo 'Just now')"
  } > "$temp_dir/pr_$pr_number"
}

get_prs_in_repo() {
  local repo=$1
  local pr_cmd

  if [ -n "$repo" ]; then
    gh pr list --author @me --state open --json number --jq '.[].number' --repo "$repo" 2>/dev/null
  else
    gh pr list --author @me --state open --json number --jq '.[].number' 2>/dev/null
  fi
}

check_all_prs_in_repo() {
  local repo=$1

  # Print header
  print_header_line "ðŸ“Š PR Status Report"
  printf "\n"
  
  if [ -n "$repo" ]; then
    printf "%b Repository:%b $repo\n" "${BLUE}${BOLD}" "${NC}"
  else
    printf "%b Repository:%b Current\n" "${BLUE}${BOLD}" "${NC}"
  fi
  printf "%b Fetching status...%b\n\n" "${YELLOW}" "${NC}"

  local prs
  prs=$(get_prs_in_repo "$repo") || {
    printf "%bâœ— Error:%b Could not fetch PRs\n" "${RED}${BOLD}" "${NC}"
    return 1
  }

  if [ -z "$prs" ]; then
    printf "%bâœ“ No open PRs found%b\n" "${GREEN}${BOLD}" "${NC}"
    return 0
  fi

  # Create temp directory for collecting output
  local temp_dir
  temp_dir=$(mktemp -d)

  # Process PRs in parallel
  while read -r pr_number; do
    check_single_pr "$pr_number" "$repo" "$temp_dir" &
  done <<< "$prs"

  # Wait for all background jobs
  wait

  # Print collected output in order
  while read -r pr_number; do
    cat "$temp_dir/pr_$pr_number"
  done <<< "$prs"

  # Print footer
  printf "\n"
  print_separator
  printf "%b Generated at: %s%b\n" "${DIM}" "$(date +'%Y-%m-%d %H:%M:%S')" "${NC}"
  printf "\n"

  # Cleanup
  rm -rf "$temp_dir"
}

# Check if we're in a git repository
is_in_git_repo() {
  git rev-parse --git-dir > /dev/null 2>&1
  return $?
}

# Check if argument is a repo (contains /)
is_repo_format() {
  [[ "$1" == *"/"* ]]
}

# Get current repo from git
get_current_repo() {
  local remote_url
  remote_url=$(git config --get remote.origin.url 2>/dev/null)
  if [ -z "$remote_url" ]; then
    return 1
  fi
  # Extract owner/repo from URL
  echo "$remote_url" | sed -E 's|.*[:/]([^/]+)/([^/]+)(.git)?$|\1/\2|'
}

# Main logic
case $# in
  0)
    # Scenario 0: no args
    if is_in_git_repo; then
      current_repo=$(get_current_repo)
      if [ $? -eq 0 ] && [ -n "$current_repo" ]; then
        check_all_prs_in_repo "$current_repo"
      else
        printf "%bâœ— Error:%b Could not determine current repository\n" "${RED}${BOLD}" "${NC}"
        exit 1
      fi
    else
      printf "%bâœ— Error:%b Not in a git repository\n" "${RED}${BOLD}" "${NC}"
      printf "\n%bUsage:%b\n" "${BLUE}${BOLD}" "${NC}"
      printf "  %bpr-status%b                              (all PRs in current repo)\n" "${CYAN}" "${NC}"
      printf "  %bpr-status <owner/repo>%b                 (all PRs in repo)\n" "${CYAN}" "${NC}"
      printf "  %bpr-status <pr_number>%b                  (must be in a git repo)\n" "${CYAN}" "${NC}"
      printf "  %bpr-status <owner/repo> <pr_number>%b     (specific PR in repo)\n\n" "${CYAN}" "${NC}"
      exit 1
    fi
    ;;
  1)
    # Could be: repo OR pr_number
    if is_repo_format "$1"; then
      # Scenario 2: REPO specified, no PR
      check_all_prs_in_repo "$1"
    else
      # Could be PR number
      if is_in_git_repo; then
        # Scenario 3: CD exists, no REPO, PR specified
        print_header_line "ðŸ“Š PR Details"
        printf "\n"
        temp_dir=$(mktemp -d)
        check_single_pr "$1" "" "$temp_dir"
        cat "$temp_dir/pr_$1"
        printf "\n"
        print_separator
        printf "\n"
        rm -rf "$temp_dir"
      else
        # Scenario 1: no CD, no REPO, but PR - raise error
        printf "%bâœ— Error:%b Cannot find PR #$1 without repository context\n" "${RED}${BOLD}" "${NC}"
        printf "\n%bUsage:%b\n" "${BLUE}${BOLD}" "${NC}"
        printf "  %bpr-status%b                              (all PRs in current repo)\n" "${CYAN}" "${NC}"
        printf "  %bpr-status <owner/repo>%b                 (all PRs in repo)\n" "${CYAN}" "${NC}"
        printf "  %bpr-status <pr_number>%b                  (must be in a git repo)\n" "${CYAN}" "${NC}"
        printf "  %bpr-status <owner/repo> <pr_number>%b     (specific PR in repo)\n\n" "${CYAN}" "${NC}"
        exit 1
      fi
    fi
    ;;
  2)
    # Scenario 4: REPO and PR specified
    print_header_line "ðŸ“Š PR Details"
    printf "\n"
    temp_dir=$(mktemp -d)
    check_single_pr "$2" "$1" "$temp_dir"
    cat "$temp_dir/pr_$2"
    printf "\n"
    print_separator
    printf "\n"
    rm -rf "$temp_dir"
    ;;
  *)
    printf "%bâœ— Error:%b Invalid arguments\n" "${RED}${BOLD}" "${NC}"
    printf "\n%bUsage:%b\n" "${BLUE}${BOLD}" "${NC}"
    printf "  %bpr-status%b                              (all PRs in current repo)\n" "${CYAN}" "${NC}"
    printf "  %bpr-status <owner/repo>%b                 (all PRs in repo)\n" "${CYAN}" "${NC}"
    printf "  %bpr-status <pr_number>%b                  (must be in a git repo)\n" "${CYAN}" "${NC}"
    printf "  %bpr-status <owner/repo> <pr_number>%b     (specific PR in repo)\n\n" "${CYAN}" "${NC}"
    exit 1
    ;;
esac
